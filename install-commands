# All kind/helm commands are executed from helm/charts

# Create cluster 
kind create cluster --config provision/local/kind-cluster.yml

# Create secrets.yaml file from secrets.yaml.template
cp secrets.yaml.template secrets.yaml
# And fill the secret values file with self generated passwords

# Local storage:
kubectl apply -f provision/local/local-path-storage.yml
# PVC data is now under /data/local-path-provisioner/
# 
# Local ingress
kubectl apply -f provision/local/nginx-kind.yml

# Logging
helm upgrade --wait --render-subchart-notes --install --create-namespace --namespace logging -f provision/local/values.yaml -f secrets.yaml elastic charts/elastic

# Applications
helm upgrade --wait --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml redis ./redis
helm upgrade --wait --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml rabbitmq ./rabbitmq
helm upgrade --wait --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml mongodb ./mongodb
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml antivirus ./antivirus
helm upgrade --wait --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml scserver ./scserver
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml client ./client
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml nuxtclient ./nuxtclient
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml calendar ./calendar
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml notification ./notification
helm upgrade        --render-subchart-notes --install --create-namespace --namespace localdev -f ../../localdev/values.yaml -f ../../localdev/secrets.yaml content ./content

# Dataimport
# in schulcloud-calendar
kubectl port-forward services/calendar-postgresql 5432:5432 -n localdev
psql -h localhost -w -U node -d schulcloud_calendar -a -f schema.sql
psql -h localhost -w -U node -d schulcloud_calendar -a -f example_data.sql
# in schulcloud-server
kubectl port-forward services/scserver-mongodb 27017:27017 -n localdev
export MONGO_USERNAME=SECRET
export MONGO_PASSWORD=SECRET
npm run setup
